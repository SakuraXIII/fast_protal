<!doctype html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="/static/dropzone-basic.min.css">
    <link rel="stylesheet" href="/static/dropzone.min.css">
</head>

<body style="padding: 10px;">
<div class="container">
    <div id="upload-file">
        <div class="mb-3 dropzone" id="dropfile">
            <div class="preview-container" style="display: flex; flex-wrap: wrap;"></div>
        </div>
        <button type="submit" class="btn btn-primary" id="submit_file" disabled>上传</button>
        <div class="progress-outside progress" style="opacity: 0; margin: 10px 0">
            <div class="progress-inner progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%
            </div>
        </div>
    </div>
    <ol class="list-group list-group-numbered">
        <li class="list-group-item"><a href="/?name=../" id="prev">..</a></li>

        {% for file in files|sort %}
        <li class="list-group-item">
            <a href=" /?name={{file}}">{{file.name}}</a>
            {% if file.is_file()%}
            &nbsp;&nbsp;&nbsp;
            <a class="badge text-bg-primary" href="/?name={{file}}" download>下载</a>
            {% endif %}
        </li>
        {% endfor %}
    </ol>
</div>
<script src="/static/bootstrap.bundle.min.js"></script>
<script src="/static/dropzone.min.js"></script>
<script>
    //时间格式转换：
    function time_format(s) {
        var t;
        if (s > -1) {
            var hour = Math.floor(s / 3600);
            var min = Math.floor(s / 60) % 60;
            var sec = s % 60;
            var day = parseInt(hour / 24);
            if (day > 0) {
                hour = hour - 24 * day;
                t = day + "day " + hour + ":";
            }
            else t = hour + ":";
            if (min < 10) {
                t += "0";
            }
            t += min + ":";
            if (sec < 10) {
                t += "0";
            }
            t += sec;
        }
        return t;
    }
</script>
<script>

    Dropzone.autoDiscover = false; //取消自动发现
    var myDropzone = new Dropzone('#dropfile', {
        url: "/upload",
        method: "post",
        paramName: "file",
        uploadMultiple: false,  // uploadMultiple 与 chunking 不能共存
        filesizeBase: 1024,  // 1000 还是 1024 作为基数单位
        chunking: true,
        chunkSize: 1024 * 1024 * 20, // 20MB
        maxFilesize: 1024 * 1024 * 1024 * 5, // 最大5GB文件
        autoProcessQueue: false,  // 拖入文件立即自动上传
        parallelUploads: 1,
        dictDefaultMessage: '拖动文件至此或者点击上传',
        //dictMaxFilesExceeded: "您最多只能上传1个文件！",
        dictResponseError: '文件上传失败!',
        //dictInvalidFileType: "文件类型只能是*.jpg,*.gif,*.png,*.jpeg。",
        dictFallbackMessage: "浏览器不受支持",
        dictFileTooBig: "文件过大上传文件最大支持.",
        dictRemoveFile: "删除",
        dictCancelUpload: "取消",
        previewTemplate: `<div class="dz-file-preview" style="margin: 0.5em 2em;">
            <button type="button" class=" btn btn-primary position-relative" data-dz-remove>
                <div class="dz-filename">
                    <span data-dz-name></span>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" data-dz-size></span>
                </div>
            </button>
        </div>`,
        previewsContainer: 'div.preview-container',
        init: function () {
            console.log('init')
            document.querySelector('#submit_file').addEventListener('click', () => {
                if (this.getAcceptedFiles().length !== 0) {
                    this.processQueue();
                }
            })
            this.on('addedfile', function (file) {
                document.querySelector('#submit_file').removeAttribute('disabled')
                document.querySelector('.progress-outside').style.opacity = 0
                document.querySelector('.progress-inner').style.width = 0 + "%"
                document.querySelector('.progress-inner').innerHTML = 0 + "%"
            })
            this.on('removedfile', function (file) {
                // console.log(this.getAcceptedFiles())
                // console.log(this.getRejectedFiles())
                // console.log(this.getQueuedFiles())
                // console.log(this.getUploadingFiles())
                if (this.getAcceptedFiles().length == 0) {
                    document.querySelector('#submit_file').setAttribute('disabled', true)
                }
            })
            this.on('uploadprogress', function (file, progress, size) {
                document.querySelector('.progress-outside').style.opacity = 100
                document.querySelector('.progress-inner').style.width = progress + "%"
                document.querySelector('.progress-inner').innerHTML = parseInt(progress) + "%"
                var mm = 0;
                var byte = 0;
                var tt = setInterval(function () {
                    mm++;
                    var byte2 = bytes;
                    var remain;
                    var speed;
                    var byteKb = byte / 1024;
                    var bytesKb = bytes / 1024;
                    var byteMb = byte / 1024 / 1024;
                    var bytesMb = bytes / 1024 / 1024;
                    if (byteKb <= 1024) {
                        speed = (parseFloat(byte2 - byte) / (1024) / mm).toFixed(2) + " KB/s";
                        remain = (byteKb - bytesKb) / parseFloat(speed);
                    } else {
                        speed = (parseFloat(byte2 - byte) / (1024 * 1024) / mm).toFixed(2) + " MB/s";
                        remain = (byteMb - bytesMb) / parseFloat(speed);
                    }
                    $("#dropz #speed").text("上传速率：" + speed);
                    $("#dropz #time").text("剩余时间" + time_format(parseInt(remain)));
                    if (bytes >= byte) {
                        clearInterval(tt);
                        if (byteKb <= 1024) {
                            $("#dropz #speed").text("上传速率：0 KB/s");
                        } else {
                            $("#dropz #speed").text("上传速率：0 MB/s");
                        }
                        $("#dropz #time").text("剩余时间：0:00:00");
                    }
                }, 1000)
            })
            this.on('success', function (file, callback) {
                this.removeFile(file);
            })
            this.on("error", function (file, data) {
                // 上传失败触发的事件
                document.querySelector('.progress-inner').classList.add('bg-danger')
                document.querySelector('.progress-inner').style.width = 100 + "%"
                document.querySelector('.progress-inner').innerHTML = 'error!'
                this.removeAllFiles() // true 删除所有文件，包括正在上传的文件
            });
        }
    })
</script>

</body>

</html>